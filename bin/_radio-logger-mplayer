#!/bin/bash

LOGF=$1
while true
do
  read -d ';'
  if [[ ${REPLY} =~ " finished." ]]; then
    # on getting
    #[0:02] Decoding of lush-128.mp3 finished.
    echo > /tmp/streamurl; echo > /tmp/streamtitle; echo "exited..."
    break;
  fi
  if [ ! -z "$REPLY" ]; then

    if [[ -z $ICY_NAME ]]; then
      ICY_NAME=$(echo "$REPLY"| grep ICY-NAME|sed s/ICY-NAME:\//g|sed s/\'$//g);
      if [[ -n $ICY_NAME ]]; then echo; echo $ICY_NAME; fi
    fi
    if [[ -z $ICY_URL ]]; then
      ICY_URL=$(echo "$REPLY"| grep ICY-URL|sed s/ICY-URL:\//g|sed s/\'$//g);
      if [[ -n $ICY_URL ]]; then echo $ICY_URL; echo; fi
    fi

    TRACK=$(echo "$REPLY"| grep ICY-META|sed s/ICY-META:\ StreamTitle=\'//g|sed s/\'$//g);
    if [[ -n $TRACK ]]; then
      (notify-send -i $2 "$TRACK" && TIM=`date +%H:%M` && DAT=`date +%Y%m%d` && echo $TRACK && echo $TRACK > /tmp/streamtitle && echo "$TIM $TRACK" >> "$LOGF-$DAT.log")
    fi
    sleep 1;
  fi
done

#MPlayer 1.2.1 (Debian), built with gcc-5.4.0 (C) 2000-2016 MPlayer Team
#mplayer: could not connect to socket
#mplayer: No such file or directory
#Failed to open LIRC support. You will not be able to use your remote control.

#Playing http://162.244.81.98:8170/mobile.
#Resolving 162.244.81.98 for AF_INET6...

#Couldn't resolve name for AF_INET6: 162.244.81.98
#Connecting to server 162.244.81.98[162.244.81.98]: 8170...

#Name   : 70s Disco Nights
#Genre  : 70s, Disco, Funk, Soul, HiNrg
#Website: https://70sdisconights.com/
#Public : no
#Bitrate: 48kbit/s
#Cache size set to 320 KBytes
#Cache fill:  0.00% (0 bytes)
#ICY Info: StreamTitle='Dee D. Jackson - Automatic Lover';
#Cache fill: 15.00% (49152 bytes)

# ICY Info: StreamTitle='Dee D. Jackson - Automatic Lover';
# ICY Info: StreamTitle='Paul Parker - Time After Time';
#


#
#
#MPlayer interrupted by signal 2 in module: enable_cache
#
#
#MPlayer interrupted by signal 2 in module: play_audio
#A: 239.5 (03:59.5) of 0.0 (unknown)  0.8% 22%
#
#Exiting... (Quit)

